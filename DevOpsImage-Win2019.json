{
  "type": "Microsoft.VirtualMachineImages/imageTemplates",
  "apiVersion": "2019-05-01-preview",
  "location": "<region>",
  "dependsOn": [],
  "tags": {
    "imagebuilderTemplate": "windows2019"
  },
  "properties": {
    "buildTimeoutInMinutes": 100,
    "vmProfile": {
      "vmSize": "Standard_D1_v2",
      "osDiskSizeGB": 127
    },
    "source": {
      "type": "PlatformImage",
      "publisher": "MicrosoftWindowsServer",
      "offer": "WindowsServer",
      "sku": "2019-Datacenter",
      "version": "2019.0.20190214"
    },
    "customize": [
            {
                "type": "PowerShell",
                "name": "settingUpMgmtAgtPath",
                "runElevated": false,
                "inline": [
                    "mkdir c:\\buildActions",
                    "echo Azure-Image-Builder-Was-Here  > c:\\buildActions\\buildActionsOutput.txt"
                ]
            },
            {
                "type": "PowerShell",
                "name": "CreateImageFolder",
                "runElevated": false,
                "inline": [
                    "mkdir <root_drive>\\<image_folder>",
                    "echo <commit_id> > <root_drive>\\<image_folder>\\<commit_file>"
                ]
            },
            {
                "type": "PowerShell",
                "name": "SetEnvV",
                "runElevated": false,
                "inline": [
                    "setx ImageVersion <image_version> /m",
                    "setx ImageOS <image_os> /m",
                    "setx IMAGE_VERSION <image_version> /m",
                    "setx IMAGEDATA_FILE <imagedata_file> /m",
                    "setx GITHUB_FEED_TOKEN <github_feed_token> /m",
                    "setx ROOT_FOLDER <root_folder> /m",
                    "setx GO_VERSIONS 1.10.8,1.11.12,1.12.7,1.13 /m",
                    "setx GO_DEFAULT 1.12.7 /m",
                    "setx BOOST_VERSIONS 1.69.0,1.72.0 /m",
                    "setx BOOST_DEFAULT 1.72.0 /m",
                    "setx ROOT_FOLDER <root_folder> /m"
                ]
            },
            {
                "type": "PowerShell",
                "runElevated": true,
                "scriptUri": "https://raw.githubusercontent.com/sehjoan/DevOpsBuildImages/master/Scripts/Upload-ImageHelpers.ps1"
            },
            {
                "type": "PowerShell",
                "runElevated": true,
                "scriptUri": "<template_dir>/scripts/Installers/Windows2019/Initialize-VM.ps1"
            }
    ],
    "distribute": [
      {
        "type": "ManagedImage",
        "imageId": "/subscriptions/<subscriptionID>/resourceGroups/<rgName>/providers/Microsoft.Compute/images/<imageName>",
        "location": "<region>",
        "runOutputName": "<runOutputName>",
        "artifactTags": {
          "source": "azVmImageBuilder",
          "baseosimg": "windows2019"
        }
      }
    ]
  }
}
